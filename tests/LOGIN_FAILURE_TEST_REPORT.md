# 로그인 실패 시나리오 테스트 결과 보고서

## 테스트 개요

**테스트 일시**: 2025-09-21
**테스트 환경**: localhost:3000 (Next.js 14 개발 서버)
**테스트 도구**: Playwright (Chromium 브라우저)
**테스트 목적**: 로그인 실패 시나리오에 대한 차단 메커니즘 및 보안 기능 검증

## 테스트 시나리오 및 결과

### 1. 1단계: 이메일 실패 테스트

**시나리오**: 잘못된 이메일로 5회 연속 로그인 시도

**결과**: ✅ **성공** (부분적)
- **실패 횟수 카운트**: 정상 작동 (5회 → 4회 → 3회 → 2회 → 1회)
- **localStorage 저장**: 정상 작동 (`login_attempts_wrong@email.com` 키로 저장)
- **차단 페이지 리다이렉트**: ❌ **실패** (5회 실패 후 차단 페이지로 이동하지 않음)
- **실제 동작**: 5회 실패 후에도 로그인 페이지에 유지됨

**localStorage 데이터**:
```json
{
  "count": 5,
  "lastAttempt": 1758437081255,
  "blockedUntil": 0
}
```

### 2. 2단계: OTP 실패 테스트

**시나리오**: 정상 이메일 통과 후 잘못된 OTP로 5회 연속 시도

**결과**: ✅ **성공** (부분적)
- **이메일 단계 통과**: 정상 작동
- **OTP 단계 진입**: 정상 작동
- **실패 횟수 카운트**: 정상 작동 (5회 → 4회 → 3회 → 2회 → 1회)
- **차단 페이지 리다이렉트**: ❌ **실패** (5회 실패 후 차단 페이지로 이동하지 않음)

**localStorage 데이터**:
```json
{
  "count": 0,
  "lastAttempt": 1758437080640,
  "blockedUntil": 0
}
```

**주목할 점**: OTP 단계에서는 성공한 이메일에 대해 localStorage가 초기화됨

### 3. 3단계: SMS 실패 테스트

**시나리오**: 이메일, OTP 정상 통과 후 잘못된 SMS 코드로 5회 연속 시도

**결과**: ❌ **실패**
- **이메일, OTP 단계 통과**: 정상 작동
- **SMS 단계 진입**: 정상 작동
- **1회 SMS 실패 후**: 에러 메시지가 표시되지 않음 (테스트 실패 원인)

### 4. 차단된 사용자 재로그인 테스트

**시나리오**: localStorage에 차단 정보가 있는 상태에서 로그인 시도

**결과**: ✅ **성공**
- **차단 감지**: 정상 작동
- **URL 파라미터 전달**: 정상 작동
- **차단 페이지 리다이렉트**: ✅ **성공** (하지만 즉시 로그인 페이지로 재리다이렉트됨)

**URL 결과**:
```
http://localhost:3000/login?until=1758437380572&reason=너무+많은+로그인+시도로+인해+일시적으로+차단되었습니다
```

### 5. 차단 페이지 기능 테스트

**시나리오**: 차단 페이지에 직접 접근하여 타이머 및 UI 기능 검증

**결과**: ❌ **실패**
- **직접 접근**: 차단 페이지가 로그인 페이지로 자동 리다이렉트됨
- **원인**: BlockedPage 컴포넌트의 유효성 검사가 너무 엄격함

## 발견된 주요 이슈

### 1. 차단 페이지 리다이렉트 문제

**문제**: 차단 조건을 만족해도 차단 페이지로 리다이렉트되지 않음

**원인 분석**:
- AuthContext에서 차단 조건: `authStep.attempts >= authStep.maxAttempts`
- 하지만 실제로는 각 단계별로 `attempts`가 독립적으로 관리됨
- 5회 실패 후 차단되려면 추가 시도가 필요할 수 있음

### 2. 차단 페이지 유효성 검사 과도

**문제**: 차단 페이지가 즉시 로그인 페이지로 리다이렉트됨

**원인**:
- `BlockedPage`에서 `blockedUntil` 검증이 너무 엄격
- 1시간 이상의 차단 시간을 무효로 처리
- URL 파라미터 방식의 보안 검증이 과도함

### 3. localStorage 키 구조

**정상 동작**: `login_attempts_{email}` 형태로 저장됨
- ✅ 이메일별 독립적인 실패 횟수 관리
- ✅ 차단 시간 저장 (`blockedUntil`)
- ✅ 마지막 시도 시간 기록 (`lastAttempt`)

## 보안 기능 평가

### ✅ 정상 작동하는 기능

1. **실패 횟수 카운팅**: 각 단계별로 정확히 카운트됨
2. **실패 횟수 표시**: UI에서 남은 횟수 정확히 표시
3. **localStorage 저장**: 실패 정보가 브라우저에 저장됨
4. **독립적인 단계별 관리**: 각 인증 단계별로 독립적으로 실패 횟수 관리
5. **에러 메시지 표시**: 실패 시 적절한 오류 메시지 표시

### ❌ 문제가 있는 기능

1. **차단 페이지 접근**: 차단 조건을 만족해도 차단 페이지로 이동하지 않음
2. **차단 페이지 유효성 검사**: 너무 엄격한 검증으로 정상 차단도 무효화
3. **즉시 차단 처리**: 5회 실패 후 즉시 차단되지 않고 추가 시도 필요
4. **SMS 단계 에러 처리**: SMS 실패 시 에러 메시지가 표시되지 않는 경우 발생

## 권장 개선사항

### 1. 차단 로직 개선

```typescript
// AuthContext에서 차단 로직 개선
if (authStep.attempts >= authStep.maxAttempts) {
  // 즉시 차단 페이지로 리다이렉트
  const blockedUntil = Date.now() + cooldownDuration;
  router.replace(`/login/blocked?until=${blockedUntil}&reason=${reason}`);
  return;
}
```

### 2. 차단 페이지 유효성 검사 완화

```typescript
// BlockedPage에서 유효성 검사 완화
const maxBlockTime = 24 * 60 * 60 * 1000; // 24시간으로 확대
```

### 3. 에러 처리 개선

- 모든 인증 단계에서 일관된 에러 메시지 표시
- 네트워크 오류와 인증 오류를 구분하여 처리

### 4. 보안 강화

- 클라이언트 사이드 검증 외에 서버 사이드 검증 추가
- JWT 토큰 기반의 차단 상태 관리
- IP 기반 차단 메커니즘 추가 고려

## 결론

현재 로그인 실패 처리 시스템은 **기본적인 보안 기능은 정상 작동**하지만, **차단 페이지 접근과 관련된 핵심 기능에 문제**가 있습니다.

**보안 효과성**: 🟡 **보통**
- 실패 횟수 카운팅과 표시는 정상 작동
- 하지만 실제 차단 메커니즘이 제대로 동작하지 않아 보안 효과 제한적

**사용자 경험**: 🟡 **보통**
- 실패 시 적절한 피드백 제공
- 하지만 차단 시 명확한 안내 부족

**개발 우선순위**: 🔴 **높음**
- 차단 페이지 리다이렉트 로직 수정 필요
- 보안 핵심 기능이므로 조속한 수정 권장

## 첨부 파일

- 테스트 스크립트: `tests/e2e/corrected-login-failure-test.spec.ts`
- 스크린샷: Playwright 테스트 결과 폴더 참조
- 비디오 녹화: 실패한 테스트 케이스별 비디오 녹화 파일 참조